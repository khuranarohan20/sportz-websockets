---
phase: 04-api-routes-middleware
plan: 03
type: execute
---

<objective>
Convert commentary routes to TypeScript with proper Express handler typing.

Purpose: Commentary routes handle nested match endpoints—type safety ensures parent match ID and request/response contracts are enforced.

Output: TypeScript commentary routes with typed Express handlers and database operations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/02-database-schema-types/02-02-SUMMARY.md
@.planning/phases/03-core-application-types/03-02-SUMMARY.md
@.planning/phases/04-api-routes-middleware/04-01-SUMMARY.md
@.planning/phases/04-api-routes-middleware/04-02-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@server/src/routes/commentary.js
@server/src/db/db.ts
@server/src/validation/commentary.ts
@server/src/validation/matches.ts

# Tech stack available: typescript, express, drizzle-orm
# Established patterns: .js imports for TypeScript files, inferred types from Zod
# Constraining decisions:
# - [Phase 3]: Use .js extensions in import paths for TypeScript files
# - [Phase 2]: Import Commentary, NewCommentary types from db.ts for database operations
# - [Phase 4]: Import validation types from validation/commentary.ts and validation/matches.ts
# - [Phase 3]: Express middleware returns void, not Response objects
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert commentary routes to TypeScript</name>
  <files>server/src/routes/commentary.ts</files>
  <action>Rename commentary.js to commentary.ts. Add type annotations:

1. Import Express types: Request, Response from 'express'
2. Import inferred validation types:
   - From validation/commentary.ts: ListCommentaryQuery, CreateCommentaryInput
   - From validation/matches.ts: MatchIdParam
3. Import database types from db.ts: Commentary, NewCommentary
4. Type all route handlers with async (req: Request, res: Response)
5. Type parsed results from Zod safeParse():
   - paramsResult with MatchIdParam
   - queryResult with ListCommentaryQuery
   - parsedBody with CreateCommentaryInput
6. Type database query results:
   - commentaryEntries: Commentary[]
   - [commentaryEntry]: Commentary[]
7. Ensure all error handlers return void (not Response objects) per Phase 3 decision

Note: Router uses mergeParams: true to access :id from parent match router—this pattern stays unchanged.

Note: app.locals.broadcastCommentary is still typed as any—it'll be properly typed in Phase 5 when WebSocket server is converted.</action>
  <verify>tsc --noEmit passes, all handlers typed correctly, no implicit any errors</verify>
  <done>All route handlers have explicit types, database operations use Commentary/NewCommentary types, validation uses inferred Zod types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes with no errors
- [ ] All Express handlers have proper Request/Response types
- [ ] Database operations use Commentary/NewCommentary types from db.ts
- [ ] Validation uses inferred types from Zod schemas
- [ ] Nested route params (matchId) properly typed via MatchIdParam
- [ ] Error handlers return void (not Response)
</verification>

<success_criteria>

- Commentary routes fully typed with TypeScript
- Request/response contracts enforced by compiler
- Database operations type-safe with Drizzle ORM types
- Validation type-safe with Zod inferred types
- Nested match ID parameter properly typed
- No TypeScript errors or implicit any types
  </success_criteria>

<output>
After completion, create `.planning/phases/04-api-routes-middleware/04-03-SUMMARY.md`:

# Phase 4 Plan 3: Commentary Routes Summary

**Converted commentary routes to TypeScript with full type safety.**

## Accomplishments

- Renamed commentary.js to commentary.ts with complete type annotations
- Added Express Request/Response types to all handlers
- Integrated database types (Commentary, NewCommentary) from db.ts
- Used inferred Zod validation types for type-safe request parsing
- Properly typed nested matchId parameter from parent route
- Ensured all error paths return void per Express middleware convention

## Files Created/Modified

- `server/src/routes/commentary.ts` - Converted from .js with full type safety

## Decisions Made

None - followed established patterns from Phases 2-3 and Plan 04-02.

## Issues Encountered

None.

## Next Step

Phase 4 complete! All API routes and middleware are now TypeScript. Ready for Phase 5: WebSocket & Real-time.
</output>
