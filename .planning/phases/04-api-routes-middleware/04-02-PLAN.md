---
phase: 04-api-routes-middleware
plan: 02
type: execute
---

<objective>
Convert match routes to TypeScript with proper Express handler typing.

Purpose: Match routes are core CRUD operations—type safety ensures request/response contracts are enforced.

Output: TypeScript match routes with typed Express handlers and database operations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/02-database-schema-types/02-02-SUMMARY.md
@.planning/phases/03-core-application-types/03-02-SUMMARY.md
@.planning/phases/04-api-routes-middleware/04-01-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@server/src/routes/matches.js
@server/src/db/db.ts
@server/src/validation/matches.ts
@server/src/utils/match-status.ts

# Tech stack available: typescript, express, drizzle-orm
# Established patterns: .js imports for TypeScript files, inferred types from Zod
# Constraining decisions:
# - [Phase 3]: Use .js extensions in import paths for TypeScript files
# - [Phase 2]: Import Match, NewMatch types from db.ts for database operations
# - [Phase 4]: Import validation types from validation/matches.ts
# - [Phase 3]: Express middleware returns void, not Response objects
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert match routes to TypeScript</name>
  <files>server/src/routes/matches.ts</files>
  <action>Rename matches.js to matches.ts. Add type annotations:

1. Import Express types: Request, Response from 'express'
2. Import inferred validation types from validation/matches.ts:
   - ListMatchesQuery
   - MatchIdParam
   - CreateMatchInput
   - UpdateScoreInput
3. Import database types from db.ts: Match, NewMatch
4. Type all route handlers with async (req: Request, res: Response)
5. Type parsed results from Zod safeParse() with inferred types
6. Type database query results (match: Match, [match]: Match[], etc.)
7. Remove manual type checking (Number.isInteger) from PATCH /:id/score handler—Zod validation schema covers this
8. Use updateScoreSchema for PATCH /:id/score validation instead of manual checks
9. Ensure all error handlers return void (not Response objects) per Phase 3 decision

Note: app.locals broadcast functions are still typed as any—they'll be properly typed in Phase 5 when WebSocket server is converted.</action>
  <verify>tsc --noEmit passes, all handlers typed correctly, no implicit any errors</verify>
  <done>All route handlers have explicit types, database operations use Match/NewMatch types, validation uses inferred Zod types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes with no errors
- [ ] All Express handlers have proper Request/Response types
- [ ] Database operations use Match/NewMatch types from db.ts
- [ ] Validation uses inferred types from Zod schemas
- [ ] PATCH /:id/score uses updateScoreSchema instead of manual validation
- [ ] Error handlers return void (not Response)
</verification>

<success_criteria>

- Match routes fully typed with TypeScript
- Request/response contracts enforced by compiler
- Database operations type-safe with Drizzle ORM types
- Validation type-safe with Zod inferred types
- No TypeScript errors or implicit any types
  </success_criteria>

<output>
After completion, create `.planning/phases/04-api-routes-middleware/04-02-SUMMARY.md`:

# Phase 4 Plan 2: Match Routes Summary

**Converted match routes to TypeScript with full type safety.**

## Accomplishments

- Renamed matches.js to matches.ts with complete type annotations
- Added Express Request/Response types to all handlers
- Integrated database types (Match, NewMatch) from db.ts
- Used inferred Zod validation types for type-safe request parsing
- Replaced manual validation in PATCH /:id/score with updateScoreSchema
- Ensured all error paths return void per Express middleware convention

## Files Created/Modified

- `server/src/routes/matches.ts` - Converted from .js with full type safety

## Decisions Made

None - followed established patterns from Phases 2-3.

## Issues Encountered

None.

## Next Step

Ready for 04-03-PLAN.md (Commentary Routes Conversion)
</output>
