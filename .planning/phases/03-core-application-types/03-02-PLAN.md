---
phase: 03-core-application-types
plan: 02
type: execute
---

<objective>
Convert configuration and environment handling to TypeScript with type-safe environment variable access.

Purpose: Ensure all configuration files have proper type safety, particularly for Arcjet security middleware and environment variable loading.
Output: Fully typed `server/src/config/` directory with environment loading and Arcjet middleware configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STACK.md
@.planning/codebase/STRUCTURE.md
@.planning/phases/01-typescript-foundation/01-01-SUMMARY.md
@.planning/phases/01-typescript-foundation/01-02-SUMMARY.md
@.planning/phases/01-typescript-foundation/01-03-SUMMARY.md
@server/src/config/env.js
@server/src/config/arcjet.js
@server/src/constants/arcjet.js
@server/src/types/env.d.ts

**Tech stack available from Phase 1:**
- TypeScript 5.9.3 with strict type checking
- Global type augmentation for process.env (from 01-02)
- @types/node@25.2.3 for Node.js types
- @types/express@5.0.6 for Express types

**Established patterns from Phase 1:**
- Pattern 1: Global augmentation for environment variable types
- Pattern 2: Custom types go in src/types/ directory
- Pattern 3: No any types allowed

**Constraining decisions from Phase 1:**
- Environment variables already have global type definitions in server/src/types/env.d.ts
- Those types are available everywhere without imports
- Must use strict type checking with no implicit any

**Key files to reference:**
- server/src/types/env.d.ts - Global env var types (created in 01-02)
- server/src/config/env.js - Simple dotenv loading
- server/src/config/arcjet.js - Arcjet middleware with conditional logic
- server/src/constants/arcjet.js - Arcjet rule constants (will convert in 03-03)

**Decisions from prior phases:**
- Phase 1-02: Created global type augmentation for process.env
- Phase 1-01: Strict type checking enabled (no implicit any)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert env.js to env.ts with type-safe dotenv loading</name>
  <files>server/src/config/env.ts</files>
  <action>Rename server/src/config/env.js to server/src/config/env.ts. Add type annotations:
  - Import configDotenv function with proper type from 'dotenv' package (dotenv includes built-in types)
  - The file is already type-safe as-is (no parameters, no return value)
  - Add JSDoc comment explaining this must be imported first in index.ts
  - No logic changes needed - dotenv's configDotenv function is already typed
  Verify TypeScript compiler recognizes the dotenv import and function call.</action>
  <verify>npm run type-check passes for env.ts, dotenv types resolved correctly</verify>
  <done>env.ts renamed, dotenv loading fully typed, no type errors</done>
</task>

<task type="auto">
  <name>Task 2: Convert arcjet.js to arcjet.ts with Arcjet client types</name>
  <files>server/src/config/arcjet.ts</files>
  <action>Rename server/src/config/arcjet.js to server/src/config/arcjet.ts. Add comprehensive type annotations:
  - Import ArcjetClient and related types from @arcjet/node (package includes built-in types)
  - Type `arcjetKey` as `string | undefined` (process.env already typed from Phase 1)
  - Type `arcjetMode` as `'LIVE' | 'DRY_RUN'` using literal types for mode values
  - Type `httpArcjet` and `wsArcjet` as `ArcjetClient | null` (nullable when ARCJET_KEY missing)
  - Type `securityMiddleware` return value as Express middleware: `(req: Request, res: Response, next: NextFunction) => void | Promise<void>`
  - Import Request, Response, NextFunction from 'express' package
  - Type decision.isDenied() return value appropriately
  - Handle the try/catch error with proper Error type
  No logic changes - only type annotations added.</action>
  <verify>npm run type-check passes for arcjet.ts, all Arcjet and Express types resolved</verify>
  <done>arcjet.ts renamed, all Arcjet clients and middleware properly typed, no type errors</done>
</task>

<task type="auto">
  <name>Task 3: Update imports in index.ts to use .ts extensions for config files</name>
  <files>server/src/index.ts</files>
  <action>Verify import paths in index.ts use .ts extensions for config files:
  - Ensure `./config/arcjet.js` changed to `./config/arcjet.ts`
  - Ensure `./config/env.js` changed to `./config/env.ts`
  - These were updated in 03-01 but verify the paths match the actual file names now
  - Run TypeScript compiler to verify module resolution works correctly
  If any import issues, fix the paths to match the renamed files.</action>
  <verify>npm run type-check passes for index.ts, all config imports resolve to .ts files</verify>
  <done>index.ts imports config files with correct .ts extensions, module resolution successful</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] `npm run type-check` passes with no errors in config/ directory
- [ ] `npm run lint` passes with no errors in config/ directory
- [ ] server/src/config/env.ts is valid TypeScript
- [ ] server/src/config/arcjet.ts is valid TypeScript
- [ ] index.ts imports from config/ files without errors
- [ ] Server starts successfully with `npm run dev`
- [ ] Arcjet middleware loads correctly (if ARCJET_KEY provided)
</verification>

<success_criteria>

- server/src/config/env.js renamed to env.ts
- server/src/config/arcjet.js renamed to arcjet.ts
- All Arcjet client types properly annotated
- Express middleware return type properly specified
- Environment variable types from Phase 1 used correctly
- No any types used (strict type checking satisfied)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-core-application-types/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Configuration & Environment Summary

**Converted configuration and environment handling to TypeScript.**

## Accomplishments

- Renamed env.js to env.ts with type-safe dotenv loading
- Renamed arcjet.js to arcjet.ts with full Arcjet client types
- Added Express middleware type annotations
- Verified environment variable types from Phase 1 work correctly

## Files Created/Modified

- `server/src/config/env.ts` - Converted from JavaScript
- `server/src/config/arcjet.ts` - Converted from JavaScript
- `server/src/index.ts` - Verified config imports (no changes if 03-01 done correctly)

## Decisions Made

- Used Arcjet's built-in types (package includes TypeScript definitions)
- Typed middleware return value as Express standard (Request, Response, NextFunction)
- Literal types for arcjetMode ('LIVE' | 'DRY_RUN') for stricter type safety

## Issues Encountered

None

## Next Step

Ready for 03-03-PLAN.md (Utility Functions and Helpers)
</output>
