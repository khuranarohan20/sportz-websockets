---
phase: 02-database-schema-types
plan: 03
type: execute
---

<objective>
Add type-safe database migration utilities and verify Drizzle Kit generates TypeScript-compatible migrations.

Purpose: Ensure database migration tooling works seamlessly with TypeScript schemas.
Output: Verified migration generation with TypeScript schemas, documented migration workflow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-schema-types/DISCOVERY.md
@.planning/phases/02-database-schema-types/02-01-SUMMARY.md
@.planning/phases/02-database-schema-types/02-02-SUMMARY.md
@server/drizzle.config.js
@server/package.json

**Tech stack available:**
- typescript@5.9.3 (from Phase 1)
- drizzle-kit@0.31.9 (TypeScript-aware migration tool)
- drizzle-orm@0.45.1 (TypeScript-native)

**Established patterns:**
- No any types allowed (Phase 1 strict type checking)
- Custom types go in src/types/ directory (Phase 1)
- Development workflow includes type-check:watch (Phase 1)

**Constraining decisions:**
- Phase 2-01: Schemas converted to TypeScript
- Phase 2-02: Database client fully typed
- Discovery: Drizzle Kit is TypeScript-aware and generates valid migrations

**Discovery findings:**
- Drizzle Kit automatically works with TypeScript schemas
- Migration files use JavaScript by default (runtime, not compiled)
- No changes needed to drizzle.config.js - it already references schema.js which is now schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Drizzle Kit configuration works with TypeScript schemas</name>
  <files>server/drizzle.config.js</files>
  <action>Drizzle Kit config currently references `schema: './src/db/schema.js'`. Since we renamed to schema.ts in 02-01, update the schema path in drizzle.config.js to `schema: './src/db/schema.ts'`. Drizzle Kit automatically handles TypeScript imports.

No other configuration changes needed - Drizzle Kit is TypeScript-aware and will import the .ts file correctly.</action>
  <verify>Run `cd server && npx drizzle-kit studio` (or any drizzle-kit command) - should not error about schema imports. Verify config file has updated schema path.</verify>
  <done>drizzle.config.js updated to reference schema.ts, Drizzle Kit imports TypeScript schemas successfully</done>
</task>

<task type="auto">
  <name>Task 2: Test migration generation from TypeScript schemas</name>
  <files>server/drizzle/</files>
  <action>Run `cd server && npm run db:generate` to verify Drizzle Kit can read TypeScript schemas and generate migration files. This command calls `drizzle-kit generate` which:
1. Imports schema.ts (TypeScript file)
2. Compares schema to database state
3. Generates SQL migration in drizzle/ directory

The migration files will be standard .sql files (not TypeScript) because migrations are runtime SQL, not application code. This is expected and correct.</action>
  <verify>Run `cd server && npm run db:generate` - should succeed with no errors. Verify drizzle/ directory exists and contains migration files (or confirms schema is up-to-date).</verify>
  <done>Migration generation succeeds with TypeScript schemas, SQL migrations created or confirmed up-to-date</done>
</task>

<task type="auto">
  <name>Task 3: Document type-safe database workflow</name>
  <files>server/CLAUDE.md</files>
  <action>Update the Database Schema section in CLAUDE.md to document the TypeScript workflow:
1. Schema definitions are in src/db/schema.ts (TypeScript)
2. Type exports available: Match, NewMatch, Commentary, NewCommentary
3. Use type-safe queries in routes: `import type { Match, NewMatch } from '../db/db.js'`
4. Generate migrations: `npm run db:generate` (Drizzle Kit reads TypeScript schemas)
5. Apply migrations: `npm run db:migrate`

Add a note that Drizzle ORM automatically infers types from schemas - no manual type definitions needed.</action>
  <verify>Run `cd server && npm run type-check` - CLAUDE.md changes shouldn't affect compilation. Inspect CLAUDE.md to verify documentation is accurate.</verify>
  <done>CLAUDE.md updated with TypeScript database workflow, type-safe patterns documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd server && npm run type-check` passes with no errors
- [ ] `cd server && npm run db:generate` succeeds
- [ ] drizzle.config.js references schema.ts
- [ ] CLAUDE.md documents TypeScript workflow
- [ ] No functional changes to database operations
</verification>

<success_criteria>

- Drizzle Kit configured for TypeScript schemas
- Migration generation verified with TypeScript schemas
- Database workflow documented with type-safe patterns
- Phase 2 complete - database layer fully typed
- Ready for Phase 3 (Core Application Types)
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-schema-types/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Migration Utilities Summary

**Verified Drizzle Kit works with TypeScript schemas and documented type-safe workflow.**

## Accomplishments

- Updated Drizzle Kit configuration for TypeScript schemas
- Verified migration generation works with schema.ts
- Documented type-safe database workflow in CLAUDE.md

## Files Created/Modified

- `server/drizzle.config.js` - Updated schema path to .ts
- `server/CLAUDE.md` - Added TypeScript database workflow documentation

## Decisions Made

[Document any decisions made during execution]

## Issues Encountered

[Document any problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 2 complete.** Database & Schema Types work finished:
- ✅ Database schemas converted to TypeScript (02-01)
- ✅ Database client fully typed with query types (02-02)
- ✅ Migration workflow verified and documented (02-03)

The database layer is now fully type-safe. Drizzle ORM's automatic type inference provides complete type safety for all database operations. Next step is Phase 3: Core Application Types (convert Express app setup, configuration, and utilities to TypeScript).
</output>
